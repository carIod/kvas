#!/bin/sh

#------------------------------------------------------------------------------
#
#	ПАКЕТ КВАС
#
#------------------------------------------------------------------------------
#
#	Данный файл служит для создания блока правил в файле конфигурации AdGuardHome,
#	где основными задачами являются:
#
#	1. Проверка наличия списочного файла и в случае его отсутствия - создаем пустой файл
#	2. В случае пустого списочного файла - создаем пустой блок ipset для файла конфигурации
#	3. В случае наличия списочного файла читаем из него строки и обрабатываем их
#	4. Записываем готовый блок ipset в файл конфигурации AdGuardHome
#
# -----------------------------------------------------------------------------
#	Разработчик: mail@zeleza.ru
#	Дата создания: 21/05/2022
#	Лицензия: Apache License 2.0
# -----------------------------------------------------------------------------
app_name="КВАС"
logger -t "${app_name}" "Запущен файл ${0}"

adguard_ipset_list_update(){
	ipset=''; domain='';
	regex='([0-9]{1,3}\.){3}[0-9]{1,3}|([0-9a-fA-F]{0,4}:){1,7}[0-9a-fA-F]{1,4}'
	adguard_config=/opt/etc/AdGuardHome/AdGuardHome.yaml
	adguard_ipset_file=/opt/etc/AdGuardHome/kvas.ipset
	host_list=/opt/etc/hosts.list

	# В случае отсутствия списочного файла создаем его
	! [ -f "${host_list}" ] && touch "${host_list}"
	# если списочный файл пуст, то создаем пустой ipset блок
	[ "$(cat < "${host_list}" | wc -l )" = 0 ] && ipset="[]"
	sed -i '/ipset/,/ipset_file/{//!d};' "${adguard_config}"

	# В случае наличия списочного файла читаем из него строки
	while read -r line || [ -n "${line}" ]; do

	# В случае наличия
	# строки - пропускаем ее
		[ -z "${line}" ] && continue
	# В случае наличия строки, которая начинается с # - пропускаем ее
		[ "${line:0:1}" = "#" ] && continue
	#	в случае если это не IP -пропускаем строку
		echo "${line}" | grep -Eq "${regex}" && continue
	#   формируем строку для блока ipset
		host="  - $(echo "${line}" | sed 's/\*//;')/unblock"
	#	Проверяем наличие сформированной строки на наличие ее файле ipset конфигурации adguard_ipset_file
		grep -q  "${host}" "${adguard_ipset_file}" && continue
	#   формируем буфер из строк для ipset
		[ -n "${domain}" ] && domain="${domain}\n${host}" || domain="${host}"

	done < "${host_list}"

#	в случае наличия данных в переменной ipset меняем ее файле.
	if [ -n "${ipset}" ]; then
#		Добаявляем данные ipset блока в отдельный файл и его имя вписываем
#		в переменную ipset_file в файле adguard_config
		echo "${domain}" >> "${adguard_ipset_file}"
		adguard_ipset_file=$(echo "${adguard_ipset_file}" | sed 's/\//\\\//g')
		sed -i 's/ipset_file.*/ipset_file: "'"${adguard_ipset_file}"'"/g' "${adguard_config}"
	fi

}

adguard_ipset_list_update
