#!/bin/sh
#------------------------------------------------------------------------------
#
#	ПАКЕТ КВАС
#
#------------------------------------------------------------------------------
#
#	Данный файл служит для добавления данных в
#	таблицу ipset данными из файла с доменными именами, IP и сетями:
#	Основное:
#	1. удаляем из строки комментарии - все что встречается после символа # и сам символ
#	2. добавляем в таблицу сети, например 134.55.16.0/24
#	3. добавляем в таблицу интервалы сетей, например 134.55.16.0-134.55.18.0
#	4. добавляем в таблицу IP адреса, например 134.55.16.34
#	5. добавляем в таблицу домены, из которых получаем сначала IP адреса
#
# ------------------------------------------------------------------------------
#	Разработчик: mail@zeleza.ru
#	Дата создания: 21/05/2022
#	Лицензия: Apache License 2.0
# ------------------------------------------------------------------------------

logger -t 'КВАС' 'Заполнение IPSet IP из списка'

# shellcheck source=opt\bin\libs\env.sh
. /opt/apps/kvas/bin/libs/env.sh

IP_FILTER='[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}'
REGEXP_IP_OR_RANGE="${IP_FILTER}|${IP_FILTER}-${IP_FILTER}|${IP_FILTER}/[0-9]{1,2}"

# обновляем таблицу ipset данными из файла с доменными именами, IP и сетями
while read -r line || [ -n "${line}" ]; do
	# пропускаем строки c минусами — это рекламные сайты
	# пропускаем пустые строки
	# пропускаем строки с комментариями
	[ "${line::1}" = "-" ] || [ -z "${line}" ] || [ "${line:0:1}" = "#" ] && continue

	# удаляем из строки комментарии - все что встречается после символа # и сам символ
	# удаляем *
	host=$(echo "${line}" | sed 's/#.*$//g' | tr -s ' ' | sed 's/\*//')

	# если строка IP, диапазон или маска; то добавляем напрямую и без ttl
	if echo "${host}" | grep -qE -- "${REGEXP_IP_OR_RANGE}"; then
		/opt/sbin/ipset -exist add "${IPSET_TABLE_NAME}" "${host}" timeout 0 &>/dev/null || true
	fi
done < "${KVAS_LIST_FILE}"