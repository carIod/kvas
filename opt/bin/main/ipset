#!/bin/sh
#------------------------------------------------------------------------------
#
#	ПАКЕТ КВАС
#
#------------------------------------------------------------------------------
#
#	Данный файл служит для добавления данных в
#	таблицу ipset данными из файла с доменными именами, IP и сетями:
#	Основное:
#	1. удаляем из строки комментарии - все что встречается после символа # и сам символ
#	2. добавляем в таблицу сети, например 134.55.16.0/24
#	3. добавляем в таблицу интервалы сетей, например 134.55.16.0-134.55.18.0
#	4. добавляем в таблицу IP адреса, например 134.55.16.34
#	5. добавляем в таблицу домены, из которых получаем сначала IP адреса
#
# ------------------------------------------------------------------------------
#	Разработчик: mail@zeleza.ru
#	Дата создания: 21/05/2022
#	Лицензия: Apache License 2.0
# ------------------------------------------------------------------------------
HOST_LIST=/opt/etc/hosts.list
TABLE_NAME=$(cat < /opt/apps/kvas/bin/libs/ndm | grep 'table_name=' | cut -d'=' -f2)
IP_FILTER='[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}'

logger -t "КВАС" "Запущен файл /opt/apps/kvas/bin/main/ipset"

# ------------------------------------------------------------------------------
# Добавляем переданные в функцию IP адреса в ipset таблицу unblock
# ------------------------------------------------------------------------------
ip_list_add_to_ipset(){

#	получаем список шз адресов от текущего dns сервера
# 	и исключаем из списка адреса типа 0.0.0.0
	ip_list=$(kdig +short "${1}" @localhost \
	| grep -Eo "${IP_FILTER}" \
	| grep -v '0.0.0.0' )

# 	если список не пуст
	[ -n "${ip_list}" ] && {
		for ip in ${ip_list}; do
			ipset list "${TABLE_NAME}" | grep -q "${ip}" || {
				ipset -exist add "${TABLE_NAME}" "${ip}"
				mess="Обнаружен новый IP=${ip} для домена ${line} и успешно добавлен в таблицу ipset."
				echo "${mess}"
				logger -t "КВАС" "${mess}"
			}
		done

	}
}


# проверяем доступность сети
until ADDRS=$(kdig +short ya.ru @localhost ) && [ -n "${ADDRS}" ] > /dev/null 2>&1; do sleep 5; done

# обновляем таблицу ipset данными из файла с доменными именами, IP и сетями
while read -r line || [ -n "${line}" ]; do

	#  пропускаем строки c минусами - это рекламные сайты
	#  пропускаем пустые строки и строки с комментариями
	#  пропускаем строки с комментариями
	[ "${line::1}" = "-" ] || [ -z "${line}" ] || [ "${line:0:1}" = "#" ] && continue

	# удаляем из строки комментарии - все что встречается после символа # и сам символ
	# удаляем *
	host=$(echo "${line}" | sed 's/#.*$//g' | tr -s ' ' | sed 's/\*//')

	# если строка начинается с IP, то проводим обработку по IP
	if echo "${host}" | grep -qoE "${IP_FILTER}"; then
		ipset -exist add "${TABLE_NAME}" "${host}" &>/dev/null
	else
		ip_list_add_to_ipset "${host}"
	fi

done < "${HOST_LIST}"

count=$(ipset list "${TABLE_NAME}" | grep -cE "^${IP_FILTER}")
echo "Общее число IP адресов в ipset составляет ${count} шт."