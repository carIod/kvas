#!/bin/sh
. /opt/apps/kvas/bin/libs/vpn
#------------------------------------------------------------------------------
#
#	ПАКЕТ КВАС
#
#------------------------------------------------------------------------------
#
#	Данный файл служит для обновления данных доменных имен, в случае, если IP у них изменились
#	Основное:
#	1. Обнуляем таблицу ipset и обновляем таблицу ipset проверяея изменения данных доменных имен
#	2. Обновляем список рекламы и в соучае необходимости убираем из него доменные имена из списочного файла
#	3. Обновляем список ipset в файле конфигурации AdGuard Home и перезапускаем его (если AdGuard Home установлен)
#	4. Обновляем список ipset в файле конфигурации dnsmasq и перезапускаем его  (если dnsmasq установлен)
#	5. Обновляем системную дату
#
# ------------------------------------------------------------------------------
#	Разработчик: mail@zeleza.ru
#	Дата создания: 21/05/2022
#	Лицензия: GPL 2.0
# ------------------------------------------------------------------------------

# Обнуляем таблицу ipset
ready "Обнуление таблицы ipset"
ipset flush unblock
[ $? = 0 ] && when_ok "ГОТОВО" || when_bad "ОШИБКА"

# Обновляем таблицу ipset
ready "Обновление таблицы ipset"
/opt/apps/kvas/bin/main/ipset &> /dev/null &
[ $? = 0 ] && when_ok "ГОТОВО" || when_bad "ОШИБКА"

# ------------------------------------------------------------------------------------------
#	 Вспомогательные переменные для работы скрипта
# ------------------------------------------------------------------------------------------
# Флаг пропуска блокировки рекламы
# 0-вЫключаем блокиратор рекламы,
# 1 - включаем блокиратор рекламы
ADS_BLOCKER_ON=0

# Обновляем список рекламы..."
if [ -z "$1" ] && [ "${ADS_BLOCKER_ON}" = 1 ]; then
	/opt/apps/kvas/bin/main/adblock
	print_line
fi

# Проверяем установлен ли AdGuard Home
if [ -f "${ADGUARDHOME_CONFIG}" ]; then
	ready "Обновление списка ipset для AdGuard Home"
	/opt/apps/kvas/bin/main/adguard
	[ $? = 0 ] && when_ok "ГОТОВО" || when_bad "ОШИБКА"

	ready "Перезапуск службы AdGuard Home"
	/opt/etc/init.d/S99adguardhome restart &>/dev/null
	[ $? = 0 ] && when_ok "ГОТОВО" || when_bad "ОШИБКА"
else
#	Если установлен dnsmasq
	ready "Обновление списка dnsmasq"
	/opt/apps/kvas/bin/main/dnsmasq
	[ $? = 0 ] && when_ok "ГОТОВО" || when_bad "ОШИБКА"

	ready "Перезапуск службы dnsmasq"
	/opt/etc/init.d/S56dnsmasq restart &>/dev/null
	[ $? = 0 ] && when_ok "ГОТОВО" || when_bad "ОШИБКА"
fi

print_line
date_update
