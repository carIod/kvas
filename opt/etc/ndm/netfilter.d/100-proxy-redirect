#!/bin/sh
. /opt/apps/kvas/bin/libs/ndm

#------------------------------------------------------------------------------
#
#	ПАКЕТ КВАС
#
#------------------------------------------------------------------------------
#
#	Данный файл служит для создания правил для пропуска Shadowsocks трафика (tcp)
#	при использовании любого shadowsocks подключения.
#	Они срабатывают при пепезаписи правил в таблице netfilter
#	https://github.com/ndmsystems/packages/wiki/Opkg-Component
#
# ------------------------------------------------------------------------------
#	Разработчик: mail@zeleza.ru
#	Дата создания: 21/05/2022
#	Лицензия: GPL 2.0
# ------------------------------------------------------------------------------

# Shadowsocks+
if ! ip4save | grep "${table_name}" | grep -q @PROXY_PORT ; then
	log_warning "Запущен файл /opt/etc/ndm/netfilter.d/100-proxy-redirect"
	log_warning "С флагами type=${type} и table=${table}"
#	 создаем правила для shadowsocks подключения
	ip4_firewall_ssr_prune &> /dev/null
	ip4_firewall_set_ssr_rules @INFACE @PROXY_PORT &> /dev/null
	exit 0
fi


