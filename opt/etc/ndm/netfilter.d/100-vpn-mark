#!/bin/sh

#------------------------------------------------------------------------------
#
#	ПАКЕТ КВАС
#
#------------------------------------------------------------------------------
#
#	Данный файл служит для создания новых правил маркировки трафика по протоколу IPv4
#	при использовании VPN подключения отличного от shadowsocks.
#	Они срабатывают при перезаписи правил в таблице netfilter
#	https://github.com/ndmsystems/packages/wiki/Opkg-Component
#	основными задачами являются:
#
#	1. Создание kvas таблицы для ipset ip4
#	2. Проверка на наличие ускорения трафика (аппаратное и программное)
#	3. В зависимости от наличия ускорения включаем те или иные правила маркировки трафика
#
# ------------------------------------------------------------------------------
#	Разработчик: mail@zeleza.ru
#	Дата создания: 21/05/2022
#	Лицензия: Apache License 2.0
# ------------------------------------------------------------------------------

# Пропускаем обработку, если тип подключения отличен от iptables
[ "$type" = "ip6tables" ] && exit 0   # check the protocol type in backward-compatible way
# shellcheck source=opt\bin\libs\ndm
. /opt/apps/kvas/bin/libs/ndm
#	маркируем правила

case "${table}" in
    mangle)
        ip4_vpn_insert_mangle &>/dev/null
        ;;
    nat)
        ip4_vpn_insert_nat &>/dev/null
        ;;
    filter)
        ip4_vpn_insert_filter &>/dev/null
        ;;
esac
