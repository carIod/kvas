#!/bin/sh
. /opt/apps/kvas/bin/libs/ndm
#------------------------------------------------------------------------------
#
#	ПАКЕТ КВАС
#
#------------------------------------------------------------------------------
#
#	Данный файл служит для создания новых правил маркировки трифика по пртоколу IPv4
#	при использовании VPN подключения отличного от shadowsocks.
#	Они срабатывают при пепезаписи правил в таблице netfilter
#	https://github.com/ndmsystems/packages/wiki/Opkg-Component
#	основными задачами являются:
#
#	1. Создание unblock для ipset ip4
#	2. Проверка на наличие ускорения трафика (аппартаное и программное)
#	3. В зависимости от наличия ускорения включаем те или иные правила маркировки трафика
#
# ------------------------------------------------------------------------------
#	Разработчик: mail@zeleza.ru
#	Дата создания: 21/05/2022
#	Лицензия: GPL 2.0
# ------------------------------------------------------------------------------


# Пропускаем обработку, если тип подключения отличен от iptables
# а сама талица отлична от mangle
if [ "${type}" = "iptables" ] ; then

	log_warning "Запущен файл /opt/etc/ndm/netfilter.d/100-vpn-mark [type=${type} и table=${table}]"

	# Создаем таблицу unblock для ipset ip4
	ip4set_create_table &> /dev/null

	case "${table}" in
		mangle)
			if fastnet_enabled ; then
				#log_warning "${app}::Проверка пройдена -> программное и аппаратное ускорение ПОДКЛЮЧЕНО."
				# Без отключения ускорителей fastnat и hwnat
				ip4_firewall_vpn_mark &> /dev/null
			else
				#log_warning "${app}::Проверка пройдена -> программное и аппаратное ускорение ОТКЛЮЧЕНО!"
				# С отключением fastnat и ускорителей hwnat
				ip4_firewall_mark_rules_tcp_udp_on &> /dev/null
			fi
			;;
		nat)
			#	в случае наличия гостевой сети
			if [ -n "${INFACE_GUEST_ENT}" ]; then
				ip4_add_guest_to_vpn_network &> /dev/null
			fi
			;;
		*)
			log_warning "Обработка таблицы ${table} пропущена, нет данных для обработки."
			;;
	esac
	exit 0
else
	exit 1
fi


