#!/bin/sh
# ------------------------------------------------------------------------------------------
#
# 	ПРОЕКТ КВАС
#
# ------------------------------------------------------------------------------------------
# 	Данный файл служит основной библиотекой функций пакета КВАС
# ------------------------------------------------------------------------------------------
#	Разработчик: kvas@zeleza.ru
#	Дата: 18/01/2024
#	Лицензия: Apache License 2.0
# ------------------------------------------------------------------------------------------

#	Подключаем библиотеку с функциями обработки ndm
. /opt/apps/kvas/bin/libs/ndm

link_up(){
	ip4set_create_table
	ip4_add_route_table
	ip4_rule_set_priority
	ip4_mark_vpn_network
}

link_down(){
	ip4_firewall_flush_vpn_rules
	ip4_rule_del_priority
	ip4_flush_all_tables
}

link_reboot(){
	link_down
	link_up
}

if [ "${1}" = "hook" ] && echo "${id}" | grep -q "$(inface_cli)"; then

	case "${layer}-${level}" in

#		Запускаем обработку при поднятии соединения
		"ctrl-running")
			link_up &> /dev/null
			logger -t "КВАС"  "Соединение ${id} успешно подключено."
		;;

#		Запускаем обработку при отключении соединении
		"ctrl-disabled" )
			link_reboot &> /dev/null
			logger -t "КВАС"  "Соединение ${id} успешно завершено."
		;;

	esac

fi

