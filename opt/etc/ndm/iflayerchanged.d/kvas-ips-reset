#!/bin/sh
# ------------------------------------------------------------------------------------------
#
# 	ПРОЕКТ КВАС
#
# ------------------------------------------------------------------------------------------
# 	Данный файл служит основной библиотекой функций пакета КВАС
# ------------------------------------------------------------------------------------------
#	Разработчик: kvas@zeleza.ru
#	Дата: 18/01/2024
#	Лицензия: Apache License 2.0
# ------------------------------------------------------------------------------------------

#	Подключаем библиотеку с функциями обработки ndm
. /opt/apps/kvas/bin/libs/ndm_d

tmp_file=/opt/tmp/sub_connection

if [ "${1}" = "hook" ]; then
#	 Действия для подключений PPTP|L2TP, которое подключено к провайдеру
	 if [[ ${id} =~ 'PPTP|L2TP' ]] && is_cli_iface_global "${id}"; then
		#	В случае отключения PPTP|L2TP соединения через основной интерфейс
		#	проще говоря, в случае если подключение к интернету осуществляется
		#	через PPTP|L2TP соединение и оно прервалось	- ставим флаг, в виде создания файла
		case "${layer}-${level}" in
			"ipv4-disabled" )
				touch "${tmp_file}"
			;;
			"ipv4-running" )
				[ -f "${tmp_file}" ] && {
					# После отключения PPTP|L2TP (которое используется для подключения к провайдеру)
					# и при наличии файла tmp_file - переустанавливаем ipset правила для восстановления
					cmd_vpn_iptable_reset
					logger -t "КВАС"  "Соединение ${id} успешно подключено, правила восстановлены!"
					rm -f "${tmp_file}"
				}
			;;
		esac
	fi

#	Действия для всех остальных подключений
	if [ "${id}" = "$(inface_cli)" ]; then
		case "${layer}-${level}" in
			"ctrl-disabled" )
				link_reboot &> /dev/null
				logger -t "КВАС"  "Соединение ${id} прервано. Правила и талицы очищены."
			;;
			"ctrl-running" )
				link_up &> /dev/null
				logger -t "КВАС"  "Соединение ${id} установлено. Правила и талицы пересозданы."
			;;
		esac
	fi
fi
