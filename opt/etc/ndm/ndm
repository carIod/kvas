#!/bin/sh
#------------------------------------------------------------------------------
#	ПАКЕТ КВАС
#------------------------------------------------------------------------------
#
#	Данный файл служит библиотекой переменых среды и функций,
#	которые используются в событийном пакете ndm
#	https://github.com/ndmsystems/packages/wiki/Opkg-Component
#
# ------------------------------------------------------------------------------
#	Разработчик: mail@zeleza.ru
#	Дата создания: 13/09/2022
#	Лицензия: GPL 2.0
# ------------------------------------------------------------------------------------------
app="КВАС"
# имя таблицы для ipset
table_name=unblock

TABLE_ID=1001
PRIORITY=1778

INFACE_CLI=@CLI_INFACE_NAME
INFACE_ENT=@ENTWARE_INFACE_NAME
INFACE_GUEST_ENT= #как пример гостевая сеть br3, которой необходимо обеспечить доступ к VPN

ip4() (/opt/sbin/ip -4 "$@")
ip4tables() (if ! /opt/sbin/iptables -C "$@" &>/dev/null; then iptables -A "$@"; fi)
ip4save() (/opt/sbin/iptables-save)

INFACE_GW4=$(ip4 addr show "${INFACE_ENT}" | grep -Po "(?<=inet ).*(?=/)")
INFACE_GUEST_GW4=$(ip addr show "${INFACE_GUEST_ENT}" | grep -Po "(?<=inet ).*(?=brd)")

# проверка на доступность программного и аппаратного ускорения
fastnet_support()(curl -s localhost:79/rci/show/version | grep -q ppe)
fast_hw_enabled()(! curl -s localhost:79/rci/show/rc/ppe | grep hardware -C1 | grep -q false)
fast_sw_enabled()(! curl -s localhost:79/rci/show/rc/ppe | grep software -C1 | grep -q false)
fastnet_enabled()(fast_hw_enabled || fast_sw_enabled)

ip4_firewall_mark_vpn(){
	if [ -z "${INFACE_GUEST_ENT}" ]; then
#		Маркируем трафик для домашней(основной) сети и прохождение пакетов через VPN подключение
		ip4tables PREROUTING -t mangle -m conntrack --ctstate NEW -m set --match-set ${table_name} dst -j CONNMARK --set-mark 0xd1000
		ip4tables PREROUTING -t mangle -m set --match-set ${table_name} dst -j CONNMARK --restore-mark
		logger "${app}::Маркировка трафика подключена при подключенном программном и аппаратном ускорении."
	else
#		Маркируем трафик для гостевой (в том числе) сети и прохождение пакетов через VPN подключение
		ip4tables PREROUTING -t mangle ! -s "${INFACE_GUEST_GW4}" -m conntrack --ctstate NEW -m set --match-set ${table_name} dst -j CONNMARK --set-mark 0xd1000
		ip4tables PREROUTING -t mangle ! -s "${INFACE_GUEST_GW4}" -m set --match-set ${table_name} dst -j CONNMARK --restore-mark
		logger "${app}::Маркировка трафика подключена, в том числе и для гостевой сети ${INFACE_GUEST_ENT} [${INFACE_GUEST_GW4}] при подключенном программном и аппаратном ускорении."
	fi
}

ip4_firewall_mark_rules_tcp_udp_on(){
	if [ -n "${INFACE_GUEST_ENT}" ]; then
		ip4tables PREROUTING -t mangle -i "${INFACE_GUEST_ENT}" -p tcp -m set --match-set ${table_name} dst -j MARK --set-mark 0xd1000
		ip4tables PREROUTING -t mangle -i "${INFACE_GUEST_ENT}" -p udp -m set --match-set ${table_name} dst -j MARK --set-mark 0xd1000
		logger "Маркировка трафика гостевой сети для tcp и udp ВКЛЮЧЕНА при ОТКлюченном программном и аппаратном ускорении."
	fi
	ip4tables PREROUTING -t mangle -i br0 -p tcp -m set --match-set ${table_name} dst -j MARK --set-mark 0xd1000
	ip4tables PREROUTING -t mangle -i br0 -p udp -m set --match-set ${table_name} dst -j MARK --set-mark 0xd1000
	logger "Маркировка трафика домашней сети для tcp и udp ВКЛЮЧЕНА при ОТКлюченном программном и аппаратном ускорении."
}

ip4_add_route_table(){
	logger "${app}::Поднимаем ${INFACE_CLI} интерфейс"
	ip4 route add table ${TABLE_ID} default via ${INFACE_GW4} dev ${INFACE_ENT} 2>/dev/null
	ip4 route show table main |grep -Ev ^default | while read -r ROUTE; do ip4 route add table ${TABLE_ID} ${ROUTE} 2>/dev/null; done
	logger "${app}::Таблица ID#${TABLE_ID} создана"
}

ip4_rule_set_priority(){
	logger "${app}::Устанавливаем приоритет таблицы ID#${TABLE_ID} в значение ${PRIORITY}"
	ip4 rule add fwmark 0xd1000 lookup ${TABLE_ID} priority ${PRIORITY} 2>/dev/null
	ip4 route flush cache
	logger "${app}::DNS кэш очищен."
}

ipset4_create_table(){
	ipset create ${table_name} hash:net family inet -exist
	logger "${app}::Таблица ${table_name} для ipset IPv4 создана"
}

ip4_mark_vpn_network(){

	if fastnet_enabled ; then
		ip4save | grep "\-j CONNMARK" | grep -qE "mark|${table_name}" || {
			# Без отключения ускорителей fastnat и hwnat
			logger "Программное и аппаратное ускорение ПОДКЛЮЧЕНО."
			ip4_firewall_mark_vpn
		}
	else
		ip4save | grep "\j MARK" | grep -q "${table_name}" || {
			# С отключением fastnat и ускорителей hwnat
			logger "Программное и аппаратное ускорение ОТКЛЮЧЕНО!"
			ip4_firewall_mark_rules_tcp_udp_on
		}
	fi
}

#----------------------------------------------------------------
#
# Функции для поддержки протокола ip6
#
#----------------------------------------------------------------
#ip6() (/opt/sbin/ip -6 "$@")
#ip6tables() (if ! /opt/sbin/ip6tables -C "$@" &>/dev/null; then ip6tables -A "$@"; fi)
#ip6save() (/opt/sbin/ip6tables-save)
#
#ipset6_create_table(){
#	ipset create "${table_name}6" hash:net family inet6 -exist
#	logger "${app}::Таблица ${table_name} для ipset IPv6 создана"
#}



}