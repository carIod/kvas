#!/bin/sh
. /opt/apps/kvas/bin/libs/ndm

#------------------------------------------------------------------------------
#
#	ПАКЕТ КВАС
#
#------------------------------------------------------------------------------
#
#	Данный файл служит для создания новых правил iptables для версии IPv4
#	при использовании VPN подключения отличного от shadowsocks,
#	при запуске монтирования какой либо файловой системы (при загрузке системы)
#	https://github.com/ndmsystems/packages/wiki/Opkg-Component
#	при заупске с командой start, где основными задачами являются:
#
#	1. Создание правил iptables для ipset для маршрутизации записей в таблице unblock
#	2. Поднятие ${INFACE_CLI} интерфейса
#	3. Создание и установка приоритета таблицы ID#${TABLE_ID} в значение ${PRIORITY}
#	4. Очистка DNS кеша
#
# ------------------------------------------------------------------------------
#	Разработчик: mail@zeleza.ru
#	Дата создания: 21/05/2022
#	Лицензия: GPL 2.0
# ------------------------------------------------------------------------------

if [ "$1" = "start" ] ; then

	log_warning "Запущен файл /opt/etc/ndm/fs.d/100-vpn"

#	Создаем талицу IP адресов для  VPN подключения отличного от shadowsocks
	ip4_add_route_table &> /dev/null
#	Устанавливаем приоритет таблицы
	ip4_rule_set_priority &> /dev/null
#	Создаем правила iptables
	ip4_mark_vpn_network &> /dev/null

	exit 0
else
	exit 1
fi
