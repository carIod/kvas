# [КВАС](https://forum.keenetic.com/topic/14415-пробуем-квас-shadowsocks-и-другие-vpn-клиенты/?do=findComment&comment=152234): Руководство по сборке образа и пакета

### Принципы сборки имиджа и самого пакета **Квас**
1. Сборка образа должна осуществляется на многоядерном коммьютере
2. Сборка образа собирается **под пользователем отличным от root** (имя и **id** задается в файле **/apps/kvas/image.build** )
3. Работа с исходниками проекта, внесение правок осуществляется на компьтере (в привычной Вам IDE), но сама сборка пакета осуществляется в контейнере на основе собранного образа kvas_develop
4. Сам образ можно скачать из репозитрия Docker [zeleza/kvas](https://hub.docker.com/r/zeleza/kvas) или собрать его самостоятельно по инстуркции ниже 

### Структура файлов
- **/apps/kvas/Dockerfile** - файл в котором собержится информация по сборке образа
- **/apps/kvas/docker-compose.yml** - файл сборки образа и запуска контейнера после сборки (ручной режим)
- **/apps/kvas/.env** - файл содержит переменные среды окружения и сборки образа (создает автоматически)
- **/apps/kvas/image.build** - файл для автоматической сборки образа kvas_develop (автоматический режим)
- **/apps/kvas/build/Makefile.build** - файл сборки файла Makefile для сборки пакета Квас
- **/apps/kvas/build/firstrun.build** - файл сборки образа kvas_develop, который собирает tools и toolchain
- **/apps/kvas/build/library.run** - файл библиотеки, который содаржит функции и используется для firstrun.build
- **/apps/kvas/build/package.build** - файл сборки пакета Квас, котрый используется при внесении измений в данные пакета при входе в терминал ранее собранного контрейнера н абазе образа kvas_develop
- **/apps/kvas/build/postinst** - файл первичной установки пакета квас на роутере при команде opkg install. Используется при сборке Makefile.build
- **/apps/kvas/build/postterm** - файл удаления пакета квас на роутере при команде opkg remove. Используется при сборке Makefile.build
- **/apps/kvas/build/version** - файл для ручного указания версии пакета Квас для сборки конкретного номера версии
- 
### Сборка имиджа
1. Создаем папку **/apps** на рабочем компьютере, где будет осуществляться сборка образа
2. Клонируем образ из [github](https://github.com/qzeleza/kvas) 
```
mkdir /apps 
git clone https://github.com/qzeleza/kvas.git
```
2. Заходим в папку проекта, правим необходимые переменные в **/apps/kvas/image.build** 
    - **DEBUG=NO** - флаг отладки, необходим при запуске make при сборке имиджа 
      - **NO** -  запускаем с флагом **V=sc** (максимальное логирование) и на одном ядре
      - **YES** - запускаем без логирования и на максимально доступном числе ядер
    - **image_name="kvas_develop"** - имя образа 
    - **user=develop** - имя под которым будет осуществляться сборка пакета make (под root собирать запрещено)
    - **user_uid=5001** - id пользователя для работы с контейнером
    - **user_gid=5001** - **id** группы пользовтаеля для работы с контейнером
```
cd /apps/kvas/
nano ./image.build
```
3. Запускаем сборку образа **kvas_develop** в автоматическом режиме посредством файла **image.build**
    - в зависимости от процессора сбока имиджа собирается от **1400** до **6000** секунд 
    - размер готового образа составляет как минимум примерно **10Gb**

```
cd /apps/kvas/
./image.build
```

### Сборка пакета
1. Правим файл **./build/version** и выставляем небходимый номер релиза и версии пакета 
2. Правим исходные файлы на компьютере в папке **/apps/kvas/opt** 
3. Есть три варианта (здесь **kvas_develop** - имя собранного образа ): 
  - Если контайнера не существует, то **запускаем его под root** (см. команду ниже), где аргументы команды ниже следующие:
    - **src=/apps/kvas** - папка на компьютере где запускается сборка образа и где хранятся исходники кода пакета **Квас**
    - **dst=/apps/kvas** - папка внутри контейнера, в которой хранятся исходники кода пакета **Квас** 
    - **kvas_develop** - имя собранного образа
```
docker run -it --mount type=bind,src=/apps/kvas,dst=/apps/kvas kvas_develop /bin/bash
```
  - Если контейнер уже существует, но не запущен, то находим его **id** и затем запускаем его, после чего подключаемся к нему,
```
docker exec -it $(docker start $(docker ps -a | grep kvas_develop | cut -d' ' -f1)) /bin/bash
```
  - Если контейнер уже запущен (проверяем командой **docker ps**), то тогда подключаемся к нему.
```
docker exec -it $(docker ps | grep kvas_develop | cut -d' ' -f1) /bin/bash
```

4. Если контейнер был только что собран, то в этом случае, генерируем ssh ключи внутри контейнера и копируем их в буфер обмена.
```
! [ -f ~/.ssh/id_rsa ] && ssh-keygen -t rsa -N "" -f ~/.ssh/id_rsa
cat ~/.ssh/id_rsa.pub 
```
 - Далее, заходим на роутер и добавляем скопированный на предыдущем шаге ключ в файл **/opt/etc/.ssh/authorized_keys**
```
nano /opt/etc/.ssh/authorized_keys
```
5. Переходим в терминал контейнера в папку **/apps/kvas/build** (к которому мы подключились на **шаге 3**) и запускаем сборку пакета. Сборка занимает не продолжительное время (от **10** до **60** сек.), так как все необходимые файлы были уже ранее собраны при сборке образа.
```
cd /apps/kvas/build
./package.build
```
6. По окончании сборки пакета и при отсувствии ошибок Вы увидите, что 
   - пакет собран успешно и скопирован на Ваш роутер 
   - автоматически произведно удаление предыдущей версии **Кваса**. 
   - теперь, самое время перейти на роутер и запустить установку вновь собранного пакета.
```
opkg install /opt/packages/kvas_Х.Х-beta_ХХ_all.ipk
```
7. В случае наличия ошибок при сборке пакета необходимо:
  - в файле **./package.build** установить флаг **DEBUG** в состояние **YES** 
  - вновь повторить сборку пакета
```
nano /apps/kvas/build/package.build
./package.build
```
