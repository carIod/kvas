# [КВАС](https://forum.keenetic.com/topic/14415-пробуем-квас-shadowsocks-и-другие-vpn-клиенты/?do=findComment&comment=152234): Руководство по сборке образа и пакета

## Принципы сборки, запуска и тестирования пакета **Квас**
1. Сборка docker-образа среды сборки пакета должна осуществляется на многоядерном компьютере с целью снижения времени сборки пакета.
2. Сборка пакета осуществляется **под пользователем отличным от root**
3. Установка уже собранного пакета осуществляется на удаленном роутере
4. Тестирование пакета Квас осуществлятся на устройстве разработки при уже собранном и установленном пакете на удаленном роутере 
5. Работа с исходниками проекта и внесение в него своих правок осуществляется на компьютере (в привычной Вам IDE), но сама сборка пакета осуществляется в docker-контейнере на основе собранного docker-образа **kvas-dev**
6. Сам docker-образ можно скачать из репозитория Docker [zeleza/kvas](https://hub.docker.com/r/zeleza/kvas) или собрать его самостоятельно по инструкции ниже 

## Структура файлов
```
   /apps/kvas/                    - папка проекта
          ├──Dockerfile           - файл в котором содержится информация по сборке docker-образа
          ├──docker-compose.yml   - файл сборки docker-образа и запуска контейнера после сборки (ручной режим)
          ├──.env                 - файл содержит переменные среды окружения docker-образа (создается автоматически)
          ├──image.build          - СКРИПТ для автоматической сборки docker-образа kvas-dev (автоматический режим)
          └──/build/              - папка для сборки проекта
                ├──Makefile.build - файл создания файла Makefile для сборки пакета Квас
                ├──Makefile       - полученый в результате исполнения скрипта Makefile.build файл Makefile 
                ├──app.make       - СКРИПТ для сборки пакета после его изменений (описание ключей ниже)
                ├──library.run    - файл библиотеки, который содержит функции и используется для firstrun.build
                ├──firstrun.build - файл первоначальной сборки пакета kvas внутри запущенного контейнера, 
                |                   который запускает make tools и toolchain (запускается из ../image.build)
                ├──package.build  - файл первоначальной сборки пакета kvas внутри запущенного контейнера, 
                |                   который запускает сборку уже самого пакета Квас (запускается из ./app.make с ключем build)
                ├──copy.build     - файл копирования пакета kvas на роутер внутри запущенного контейнера, в случае, если нужно просто 
                |                   произвести копирование уже собранного пакета на роутер (запускается из ./app.make с ключем copy)
                ├──postinst       - файл содержащий скрипты для первичной установки пакета квас на роутере при команде opkg install. Используется при сборке в файле Makefile.build
                ├──postterm       - файл содержащий скрипты для удаления пакета квас на роутере при команде opkg remove. Используется при сборке в файле Makefile.build
                ├──version        - файл для ручной настройки версии пакета Квас для сборки конкретного номера версии
                └──README.md      - настоящий файл справки 
```

## Сборка docker-образа
1. [Устанавливаем Docker](https://docs.docker.com/engine/install/), если его нет на устройстве разработки
2. Создаем папку **./apps** на устройстве разработки, где будет осуществляться сборка docker-образа
3. Клонируем исходники из [github](https://github.com/qzeleza/kvas) 
```
mkdir ./apps 
git clone https://github.com/qzeleza/kvas.git
```

4. Запускаем сборку docker-образа **kvas-dev** в автоматическом режиме посредством файла **image.build**
    - в случае необходимости вводим запрашиваемые данные для доступа к роутеру на котором будет устанавливаться и тестироваться пакет

```
cd <корневая папка>/apps/kvas/
./image.build
```
#### ДЛЯ СПРАВКИ!
_В зависимости от мощности процессора устройства, на котором происходит сборка docker-образа, 
работа по его настройке и упаковке может занять от **20** мин. до **2** часов, а размер готового образа составляет, как минимум **10Gb**_


## Сборка пакета
1. Правим, в случае необходимости, исходные файлы в папке **/apps/kvas/opt** под свои потребности.
2. Правим файл **./build/version** - задаем необходимый номер релиза и версии пакета 
3. Запускаем сборку пакета командой **./build/app.make build**
   - Запустится сборка контейнера и сразу откроется контейнер, в случае, если он уже был ранее собран и запустится процесс сборки пакета.
   - Далее, последует удаление пакета на роутере и его последующая установка

При необходимости можно просто скопировать уже собранный пакет на роутер или зайти в контейнер для работы (см. команды ниже);

### Описание параметров запуска утилиты **./build/app.make**
| Команда        | Аргументы |
|----------------|:---------:|
| app.make build |     -     |
| app.make copy  |     -     |
| app.make term  |     -     |

```

build - сборка пакета и копирование его на роутер
copy  - копирование уже собранного пакета на роутер
term  - подключение к контейнеру без исполнения скриптов

```


